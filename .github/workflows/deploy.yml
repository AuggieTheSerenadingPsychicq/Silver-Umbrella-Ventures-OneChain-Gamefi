name: OneChain Official Deployment (FINAL + FAST)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Restore Rust cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo
            target
          key: onechain-${{ runner.os }}-${{ github.ref }}
          restore-keys: onechain-${{ runner.os }}-

      - name: Install & Deploy Contract
        env:
          MOVE_PRIVATE_KEY: ${{ secrets.MOVE_PRIVATE_KEY }}
        run: |
          set -e

          echo "Installing Rust..."
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          export PATH="$HOME/.cargo/bin:$PATH"

          echo "Installing OneChain CLI if missing..."
          if ! command -v one >/dev/null 2>&1; then
            cargo install --locked --git https://github.com/one-chain-labs/onechain.git one_chain --features tracing
            mv ~/.cargo/bin/one_chain ~/.cargo/bin/one
          else
            echo "OneChain CLI already cached âœ…"
          fi

          echo "Configuring RPC..."
          export ONE_RPC_URL="https://rpc-testnet.onelabs.cc:443"

          echo "Preparing key..."
          echo "$MOVE_PRIVATE_KEY" > /tmp/key.txt

          if [ ! -s /tmp/key.txt ]; then
            echo "ERROR: MOVE_PRIVATE_KEY is empty"
            exit 2
          fi

          echo "Importing key..."
          one keytool import "$(cat /tmp/key.txt)" ed25519

          echo "Publishing contract..."
          # FIX: Changed from 'one move publish' to 'one client publish'
          one client publish --gas-budget 20000000 --json

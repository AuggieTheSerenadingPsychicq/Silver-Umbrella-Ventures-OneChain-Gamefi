name: OneChain Official Deployment (FINAL)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Restore Rust cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo
            target
          key: onechain-${{ runner.os }}-${{ github.ref }}
          restore-keys: onechain-${{ runner.os }}-

      - name: Install & Deploy
        env:
          MOVE_PRIVATE_KEY: ${{ secrets.MOVE_PRIVATE_KEY }}
        run: |
          set -e

          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          export PATH="$HOME/.cargo/bin:$PATH"

          if ! command -v one >/dev/null 2>&1; then
            cargo install --locked --git https://github.com/one-chain-labs/onechain.git one_chain --features tracing
            mv ~/.cargo/bin/one_chain ~/.cargo/bin/one
          fi

          mkdir -p ~/.one/one_config
          cat > ~/.one/one_config/client.yaml <<EOF
activeEnv: testnet
envs:
  testnet:
    rpc: https://rpc-testnet.onelabs.cc:443
    ws:  wss://rpc-testnet.onelabs.cc/websocket
EOF

          echo "$MOVE_PRIVATE_KEY" > /tmp/key.txt
          [ ! -s /tmp/key.txt ] && echo "ERROR: Private key missing" && exit 2

          one keytool import "$(cat /tmp/key.txt)" ed25519

          one client publish --gas-budget 20000000 --json .

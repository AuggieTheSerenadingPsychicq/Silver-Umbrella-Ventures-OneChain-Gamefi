name: OneChain Final Deployment (Fast Track)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- Skip slow Rust/Cargo build and caching steps ---

      - name: Install Fast CLI and Publish Contract
        env:
          # Key is read securely from GitHub Secrets
          MOVE_PRIVATE_KEY: ${{ secrets.MOVE_PRIVATE_KEY }}
        run: |
          # --- 1. Install Dependencies ---
          sudo apt-get update
          sudo apt-get install -y curl bash

          # --- 2. Install Pre-compiled Sui CLI (Fast and compatible with OneChain RPC) ---
          echo "Installing Pre-compiled Sui CLI..."
          curl -sS https://packagecloud.io/install/repositories/neondapp/sui-cli/script.deb.sh | sudo bash
          sudo apt-get install -y sui-cli
          
          # --- 3. Prepare Key and Run Deployment ---
          # Use SUI_RPC_URL since we are using the sui tool
          export SUI_RPC_URL='https://rpc-testnet.onelabs.cc:443'
          # Write the key to a temporary file
          echo "\$MOVE_PRIVATE_KEY" > sui_key.txt
          # Import the key using the sui keytool command (compatible with suiprivkey format)
          sui keytool import-private-key --key-file sui_key.txt --env testnet
          
          echo "Starting FINAL publish transaction on OneChain Testnet (Fast Track)..."
          # Use the sui move publish command, pointing to the OneChain RPC
          sui move publish --gas-budget 20000000 --json

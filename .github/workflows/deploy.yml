name: OneChain Official Deployment (Minimalist)

on:
  workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            # Caching step to ensure speed
            - name: Cache Rust Dependencies
              uses: actions/cache@v3
              with:
                path: |
                  ~/.cargo/registry
                  ~/.cargo/git
                  target
                key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                restore-keys: ${{ runner.os }}-cargo-

            - name: Install and Deploy Contract
              env:
                MOVE_PRIVATE_KEY: ${{ secrets.MOVE_PRIVATE_KEY }}
              run: |
                # 1. Install Rust
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
                export PATH="$HOME/.cargo/bin:$PATH"

                # 2. Install Official OneChain CLI
                cargo install --locked --git https://github.com/one-chain-labs/onechain.git one_chain --features tracing
                mv ~/.cargo/bin/one_chain ~/.cargo/bin/one

                # 3. Deployment commands
                export ONE_RPC_URL='https://rpc-testnet.onelabs.cc:443'

                # FINAL SYNTAX FIX: Pass key directly as input string
                one keytool import --input-string "\$MOVE_PRIVATE_KEY" --env testnet

                # 4. Publish Contract
                one move publish --gas-budget 20000000 --json
